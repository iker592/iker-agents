name: Deploy

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Lint and format
        run: |
          uv run ruff format .
          uv run ruff check . --fix

      - name: Run unit tests
        run: uv run pytest -m unit

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Detect changed files
        id: changes
        run: |
          # Compare with previous commit to detect changes
          if git diff --name-only HEAD~1 HEAD | grep -E '^(agents/dsp/|iac/stack\.py)'; then
            echo "dsp_changed=true" >> $GITHUB_OUTPUT
          else
            echo "dsp_changed=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E '^(agents/research/|iac/research_stack\.py)'; then
            echo "research_changed=true" >> $GITHUB_OUTPUT
          else
            echo "research_changed=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E '^(agents/coding/|iac/coding_stack\.py)'; then
            echo "coding_changed=true" >> $GITHUB_OUTPUT
          else
            echo "coding_changed=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E '^(ui/|iac/ui_stack\.py)'; then
            echo "ui_changed=true" >> $GITHUB_OUTPUT
          else
            echo "ui_changed=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E '^(iac/base_stack\.py|iac/app\.py)'; then
            echo "infrastructure_changed=true" >> $GITHUB_OUTPUT
          else
            echo "infrastructure_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build UI (initial)
        if: steps.changes.outputs.ui_changed == 'true' || steps.changes.outputs.infrastructure_changed == 'true'
        run: |
          cd ui
          bun install
          VITE_API_URL=placeholder bun run build

      - name: Deploy stacks
        run: |
          echo "Change detection:"
          echo "  DSP Agent: ${{ steps.changes.outputs.dsp_changed }}"
          echo "  Research Agent: ${{ steps.changes.outputs.research_changed }}"
          echo "  Coding Agent: ${{ steps.changes.outputs.coding_changed }}"
          echo "  UI: ${{ steps.changes.outputs.ui_changed }}"
          echo "  Infrastructure: ${{ steps.changes.outputs.infrastructure_changed }}"
          echo ""

          # Build list of stacks to deploy
          STACKS=""

          if [ "${{ steps.changes.outputs.infrastructure_changed }}" = "true" ]; then
            echo "âš ï¸  Infrastructure changed - deploying all stacks"
            STACKS="--all"
          else
            [ "${{ steps.changes.outputs.dsp_changed }}" = "true" ] && STACKS="$STACKS DSPAgentStack"
            [ "${{ steps.changes.outputs.research_changed }}" = "true" ] && STACKS="$STACKS ResearchAgentStack"
            [ "${{ steps.changes.outputs.coding_changed }}" = "true" ] && STACKS="$STACKS CodingAgentStack"
            [ "${{ steps.changes.outputs.ui_changed }}" = "true" ] && STACKS="$STACKS UIStack"
          fi

          if [ -z "$STACKS" ] || [ "$STACKS" = " " ]; then
            echo "âœ… No infrastructure changes detected - skipping deployment"
            exit 0
          fi

          echo "ðŸ“¦ Deploying stacks: $STACKS"
          cdk deploy $STACKS --require-approval never --outputs-file cdk-outputs.json

      - name: Rebuild UI with API URL
        run: |
          API_URL=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('UIStack', {}).get('APIURL', ''))")
          if [ -n "$API_URL" ]; then
            echo "Rebuilding UI with API_URL: $API_URL"
            cd ui
            VITE_API_URL=$API_URL bun run build
            # Sync to S3 bucket
            BUCKET_NAME=$(cat ../cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('UIStack', {}).get('UIBucketName', ''))")
            if [ -n "$BUCKET_NAME" ]; then
              aws s3 sync dist/ s3://$BUCKET_NAME/ --delete
              # Invalidate CloudFront cache
              DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Origins.Items[0].DomainName=='$BUCKET_NAME.s3.amazonaws.com'].Id | [0]" --output text)
              if [ -n "$DISTRIBUTION_ID" ]; then
                aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
              fi
            fi
          fi

      - name: Update dev endpoints
        run: |
          for stack in DSPAgentStack ResearchAgentStack CodingAgentStack; do
            RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('$stack', {}).get('RuntimeId', ''))" 2>/dev/null || echo "")
            if [ -n "$RUNTIME_ID" ]; then
              VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID 2>/dev/null || echo "")
              if [ -n "$VERSION" ]; then
                echo "Updating $stack dev endpoint to version $VERSION"
                aws bedrock-agentcore-control update-agent-runtime-endpoint \
                  --agent-runtime-id $RUNTIME_ID \
                  --endpoint-name dev \
                  --agent-runtime-version $VERSION \
                  --region ${{ env.AWS_REGION }} || true
              fi
            fi
          done

      - name: Run E2E tests
        run: |
          ARN=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['DSPAgentStack']['RuntimeArn'])")
          AGENT_RUNTIME_ARN=$ARN AGENT_ENDPOINT=dev uv run pytest -m e2e

      - name: Promote DSPAgent to canary
        run: |
          RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['DSPAgentStack']['RuntimeId'])")
          VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID)
          aws bedrock-agentcore-control update-agent-runtime-endpoint \
            --agent-runtime-id $RUNTIME_ID \
            --endpoint-name canary \
            --agent-runtime-version $VERSION \
            --region ${{ env.AWS_REGION }}

      - name: Promote DSPAgent to prod
        run: |
          RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['DSPAgentStack']['RuntimeId'])")
          VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID)
          aws bedrock-agentcore-control update-agent-runtime-endpoint \
            --agent-runtime-id $RUNTIME_ID \
            --endpoint-name prod \
            --agent-runtime-version $VERSION \
            --region ${{ env.AWS_REGION }}

