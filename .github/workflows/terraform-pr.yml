name: PR - Build & Deploy

on:
  pull_request:
    branches: [main]
    paths:
      - 'agents/**'
      - 'agent-sdk/**'
      - 'terraform/**'
      - 'ui/**'
      - 'Dockerfile'
      - '.github/workflows/terraform-pr.yml'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  TF_VAR_aws_region: us-east-1

jobs:
  lint-and-test:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Lint
        run: make lint

      - name: Unit Tests
        run: make test-unit

  ensure-ecr-repos:
    name: Ensure ECR Repos Exist
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR repos if not exist
        run: |
          for repo in dsp-agent research-agent coding-agent mcp-server; do
            aws ecr describe-repositories --repository-names "iker-agents/${repo}" 2>/dev/null || \
              aws ecr create-repository --repository-name "iker-agents/${repo}" --image-tag-mutability MUTABLE
          done

  build-and-push:
    name: Build DSP Agent Image
    runs-on: ubuntu-latest
    needs: [lint-and-test, ensure-ecr-repos]
    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU (for arm64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${{ steps.login-ecr.outputs.registry }}/iker-agents/dsp-agent:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-research-agent:
    name: Build Research Agent Image
    runs-on: ubuntu-latest
    needs: [lint-and-test, ensure-ecr-repos]
    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU (for arm64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${{ steps.login-ecr.outputs.registry }}/iker-agents/research-agent:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Research Agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            AGENT_PATH=./agents/research
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-coding-agent:
    name: Build Coding Agent Image
    runs-on: ubuntu-latest
    needs: [lint-and-test, ensure-ecr-repos]
    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU (for arm64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${{ steps.login-ecr.outputs.registry }}/iker-agents/coding-agent:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Coding Agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            AGENT_PATH=./agents/coding
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-mcp-server:
    name: Build MCP Server Image
    runs-on: ubuntu-latest
    needs: [lint-and-test, ensure-ecr-repos]
    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU (for arm64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${{ steps.login-ecr.outputs.registry }}/iker-agents/mcp-server:${SHORT_SHA},${{ steps.login-ecr.outputs.registry }}/iker-agents/mcp-server:latest" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push MCP Server image
        uses: docker/build-push-action@v5
        with:
          context: ./agents/mcp-server
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ui:
    name: Build UI
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ui
        run: bun install

      - name: Build UI
        working-directory: ui
        env:
          VITE_API_URL: https://t042pm32d2.execute-api.us-east-1.amazonaws.com
          VITE_COGNITO_REGION: us-east-1
          VITE_COGNITO_USER_POOL_ID: us-east-1_0Och8G0S2
          VITE_COGNITO_CLIENT_ID: km1gk1jcpoud4j029bverljba
          VITE_COGNITO_DOMAIN: https://agent-ui-tf-239388734812.auth.us-east-1.amazoncognito.com
          VITE_AGENTCORE_ENDPOINT: https://bedrock-agentcore.us-east-1.amazonaws.com
          VITE_RUNTIME_ARN: arn:aws:bedrock-agentcore:us-east-1:239388734812:runtime/dsp_agent_tf-NBo13y3YHj
        run: bun run build

      - name: Upload UI dist
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [build-and-push, build-research-agent, build-coding-agent, build-mcp-server, build-ui]
    outputs:
      dsp_runtime_id: ${{ steps.outputs.outputs.dsp_runtime_id }}
      research_runtime_id: ${{ steps.outputs.outputs.research_runtime_id }}
      coding_runtime_id: ${{ steps.outputs.outputs.coding_runtime_id }}
      ui_url: ${{ steps.outputs.outputs.ui_url }}
      ui_bucket: ${{ steps.outputs.outputs.ui_bucket }}
      cloudfront_id: ${{ steps.outputs.outputs.cloudfront_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Download UI dist
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        run: |
          terraform plan -no-color \
            -var="image_tag=${{ needs.build-and-push.outputs.image_tag }}" \
            -var="research_agent_image_tag=${{ needs.build-research-agent.outputs.image_tag }}" \
            -var="coding_agent_image_tag=${{ needs.build-coding-agent.outputs.image_tag }}" \
            -var="mcp_server_image_tag=${{ needs.build-mcp-server.outputs.image_tag }}" \
            -out=tfplan 2>&1 | tee plan_output.txt

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/plan_output.txt', 'utf8').substring(0, 60000);
            const body = `## Terraform Plan

            **Images:**
            - DSP Agent: \`${{ needs.build-and-push.outputs.image_tag }}\`
            - Research Agent: \`${{ needs.build-research-agent.outputs.image_tag }}\`
            - Coding Agent: \`${{ needs.build-coding-agent.outputs.image_tag }}\`
            - MCP Server: \`${{ needs.build-mcp-server.outputs.image_tag }}\`

            <details>
            <summary>Show Plan</summary>

            \`\`\`
            ${plan}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Outputs
        id: outputs
        working-directory: terraform
        run: |
          echo "dsp_runtime_id=$(terraform output -raw dsp_agent_runtime_id)" >> $GITHUB_OUTPUT
          echo "research_runtime_id=$(terraform output -raw research_agent_runtime_id 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "coding_runtime_id=$(terraform output -raw coding_agent_runtime_id 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ui_url=$(terraform output -raw ui_url)" >> $GITHUB_OUTPUT
          echo "ui_bucket=$(terraform output -raw ui_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw ui_cloudfront_distribution_id)" >> $GITHUB_OUTPUT

      - name: Deploy UI to S3
        run: |
          aws s3 sync ui/dist s3://${{ steps.outputs.outputs.ui_bucket }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.outputs.outputs.cloudfront_id }} \
            --paths "/*"

  promote-canary:
    name: Promote to Canary
    runs-on: ubuntu-latest
    needs: terraform-deploy
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Promote DSP Agent to Canary
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.dsp_runtime_id }})
          echo "DSP Version: $VERSION"
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.dsp_runtime_id }} canary $VERSION

      - name: Promote Research Agent to Canary
        if: needs.terraform-deploy.outputs.research_runtime_id != ''
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.research_runtime_id }})
          echo "Research Version: $VERSION"
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.research_runtime_id }} canary $VERSION

      - name: Promote Coding Agent to Canary
        if: needs.terraform-deploy.outputs.coding_runtime_id != ''
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.coding_runtime_id }})
          echo "Coding Version: $VERSION"
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.coding_runtime_id }} canary $VERSION

  e2e-tests:
    name: E2E Tests (Canary)
    runs-on: ubuntu-latest
    needs: [terraform-deploy, promote-canary]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Run E2E Tests
        env:
          AGENT_RUNTIME_ARN: arn:aws:bedrock-agentcore:us-east-1:239388734812:runtime/${{ needs.terraform-deploy.outputs.dsp_runtime_id }}
          AGENT_ENDPOINT: canary
        run: make test-e2e

  promote-prod:
    name: Promote to Prod
    runs-on: ubuntu-latest
    needs: [terraform-deploy, e2e-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::239388734812:role/GitHubActions-iker-agents
          aws-region: ${{ env.AWS_REGION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Promote DSP Agent to Prod
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.dsp_runtime_id }})
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.dsp_runtime_id }} prod $VERSION

      - name: Promote Research Agent to Prod
        if: needs.terraform-deploy.outputs.research_runtime_id != ''
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.research_runtime_id }})
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.research_runtime_id }} prod $VERSION

      - name: Promote Coding Agent to Prod
        if: needs.terraform-deploy.outputs.coding_runtime_id != ''
        run: |
          VERSION=$(uv run python scripts/get_latest_version.py ${{ needs.terraform-deploy.outputs.coding_runtime_id }})
          uv run python scripts/promote_endpoint.py ${{ needs.terraform-deploy.outputs.coding_runtime_id }} prod $VERSION

      - name: Comment UI URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ Deployment Complete

            | Resource | Value |
            |----------|-------|
            | **UI URL** | ${{ needs.terraform-deploy.outputs.ui_url }} |
            | DSP Agent | \`${{ needs.terraform-deploy.outputs.dsp_runtime_id }}\` |
            | Research Agent | \`${{ needs.terraform-deploy.outputs.research_runtime_id }}\` |
            | Coding Agent | \`${{ needs.terraform-deploy.outputs.coding_runtime_id }}\` |

            **All agents promoted:** dev ✅ → canary ✅ → prod ✅`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agents Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Runtime ID |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **DSP Agent** | \`${{ needs.terraform-deploy.outputs.dsp_runtime_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Research Agent** | \`${{ needs.terraform-deploy.outputs.research_runtime_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coding Agent** | \`${{ needs.terraform-deploy.outputs.coding_runtime_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **UI URL** | ${{ needs.terraform-deploy.outputs.ui_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All agents promoted:** dev ✅ → canary ✅ → prod ✅" >> $GITHUB_STEP_SUMMARY
